# This file defines the structure of this project and how it is deployed
# to production using Databricks Asset Bundles.
# See https://docs.databricks.com/dev-tools/bundles/index.html for documentation.
bundle:
  name: {{.project_name}}

include:
  - resources/*.yml

# Deployment targets.
# The default schema, catalog, etc. for dbt are defined in dbt_profiles/profiles.yml
targets:
  dev:
    default: true
    # We use 'mode: development' to indicate this is a personal development copy.
    # Any job schedules and triggers are paused by default.
    # See also https://docs.databricks.com/dev-tools/bundles/deployment-modes.html.
    mode: development
    workspace:
      host: {{workspace_host}}

  prod:
    mode: production
    workspace:
      host: {{workspace_host}}
      # We explicitly specify /Users/{{user_name}} to make sure we only have a single copy.
      root_path: /Users/{{user_name}}/.bundle/${bundle.name}/${bundle.target}

{{- $userSpec := "" }}
{{- if is_service_principal}}
  {{- $userSpec = printf "service_principal_name: %s" user_name}}
{{- else}}
   {{- $userSpec = printf "user_name: %s" user_name}}
{{- end}}
    permissions:
      - {{ $userSpec }}
        level: CAN_MANAGE
    run_as:
      {{- if not is_service_principal}}
      # This runs as {{user_name}} in production. We could also use a service principal here,
      # see https://docs.databricks.com/dev-tools/bundles/permissions.html.
      {{- end}}
      {{ $userSpec }}
